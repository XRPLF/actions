on:
  pull_request:
    paths:
      - ".github/workflows/test-cleanup-workspace.yml"
      - ".github/actions/cleanup-workspace/**"
  push:
    branches: [main]
    paths:
      - ".github/workflows/test-cleanup-workspace.yml"
      - ".github/actions/cleanup-workspace/**"
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * *"

defaults:
  run:
    shell: bash

jobs:
  test-cleanup-before-checkout:
    strategy:
      matrix:
        os: [macos15, windows]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Determine workspace
        run: |
          WORKSPACE='${{ github.workspace }}'
          if [ '${{ runner.os }}' = 'Windows' ]; then
            WORKSPACE=$(cygpath -u "${WORKSPACE}")
          fi
          echo "WORKSPACE=${WORKSPACE}" >> $GITHUB_ENV

      - name: Create files in workspace
        run: |
          touch "${WORKSPACE}/testfile"
          mkdir -p "${WORKSPACE}/testdir"
          touch "${WORKSPACE}/testdir/inner_testfile"
          mkdir -p "${WORKSPACE}/.git"
          touch "${WORKSPACE}/.git/inner_gitfile"

      - name: List files in workspace
        run: |
          ls -RA "${WORKSPACE}"

      # Using the hash-pinned version, because we want to test it works before checkout
      - name: Cleanup workspace
        uses: XRPLF/actions/.github/actions/cleanup-workspace@01b244d2718865d427b499822fbd3f15e7197fcc

      - name: Check that workspace is empty
        run: |
          if [ "$(ls -A ${WORKSPACE})" ]; then
            echo "Workspace is not empty"
            exit 1
          else
            echo "Workspace is empty"
          fi

      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
